<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notation Game - Music Trivia</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .notation-container {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
            padding: 20px;
        }

        .staff-container {
            background: #fff;
            border: 3px solid #007bff;
            border-radius: 15px;
            padding: 40px 20px;
            margin: 20px 0;
            position: relative;
            overflow-x: auto;
        }

        .staff {
            position: relative;
            width: 100%;
            height: 200px;
            margin: 0 auto;
        }

        .staff-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #000;
            left: 0;
        }

        .clef {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 4em;
            font-weight: bold;
        }

        .note {
            position: absolute;
            font-size: 3em;
            color: #007bff;
            font-weight: bold;
            transform: translateX(-50%);
        }

        .note.whole {
            color: #000;
        }

        .keyboard-container {
            margin: 30px 0;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }

        .piano-keyboard {
            display: flex;
            justify-content: center;
            position: relative;
            margin: 0 auto;
            max-width: 700px;
        }

        .key {
            position: relative;
            cursor: pointer;
            border: 2px solid #333;
            user-select: none;
            transition: all 0.1s ease;
        }

        .white-key {
            width: 50px;
            height: 200px;
            background: #fff;
            border-radius: 0 0 8px 8px;
            margin: 0 1px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-weight: bold;
            color: #666;
        }

        .black-key {
            width: 30px;
            height: 120px;
            background: #333;
            color: #fff;
            position: absolute;
            border-radius: 0 0 5px 5px;
            z-index: 2;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            font-size: 0.8em;
        }

        .key:hover {
            transform: translateY(2px);
        }

        .key.active {
            background: #007bff !important;
            color: white !important;
        }

        .key.correct {
            background: #28a745 !important;
            color: white !important;
        }

        .key.incorrect {
            background: #dc3545 !important;
            color: white !important;
        }

        .user-sequence {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.2em;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .solfege-hint {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }

        @media (max-width: 768px) {
            .piano-keyboard {
                transform: scale(0.8);
                overflow-x: auto;
            }

            .staff {
                height: 150px;
            }

            .clef {
                font-size: 3em;
            }

            .note {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="music-trivia.html" class="back-btn">‚Üê Back to Music Trivia</a>
            <h1>üéº Notation Game</h1>
        </div>

        <div class="notation-container">
            <p class="subtitle">Read the notes on the staff and play them on the keyboard!</p>

            <div class="game-stats">
                <div class="stat-card">
                    <div class="stat-value" id="score">0</div>
                    <div>Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="level">1</div>
                    <div>Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streak">0</div>
                    <div>Streak</div>
                </div>
            </div>

            <div class="staff-container">
                <div class="staff" id="staff">
                    <!-- Staff lines will be generated by JavaScript -->
                </div>
            </div>

            <div class="solfege-hint">
                <strong>Do-La Hexachord:</strong> Do (C), Re (D), Mi (E), Fa (F), Sol (G), La (A)
            </div>

            <div class="user-sequence" id="userSequence">
                Your sequence will appear here...
            </div>

            <div class="controls">
                <button class="btn" id="newSequenceBtn">New Sequence</button>
                <button class="btn secondary" id="playBtn" disabled>Play Notes</button>
                <button class="btn secondary" id="checkBtn" disabled>Check Answer</button>
                <button class="btn secondary" id="clearBtn">Clear</button>
            </div>

            <div class="keyboard-container">
                <div class="piano-keyboard" id="keyboard">
                    <!-- Piano keys will be generated by JavaScript -->
                </div>
            </div>

            <div class="info-box" style="margin-top: 30px;">
                <h3>How to Play:</h3>
                <p>1. Click "New Sequence" to generate 6 random notes from the Do-La hexachord</p>
                <p>2. Study the notes displayed on the musical staff</p>
                <p>3. Click the piano keys in the correct order to match the sequence</p>
                <p>4. Use "Play Notes" to hear the correct sequence if you have audio enabled</p>
                <p>5. Click "Check Answer" when you're ready to submit your sequence</p>
            </div>
        </div>
    </div>

    <script>
        class NotationGame {
            constructor() {
                this.notes = [
                    { name: 'C', solfege: 'Do', position: 'below', offset: 10 },
                    { name: 'D', solfege: 'Re', position: 'line-4', offset: 0 },
                    { name: 'E', solfege: 'Mi', position: 'space-3', offset: -10 },
                    { name: 'F', solfege: 'Fa', position: 'line-3', offset: -20 },
                    { name: 'G', solfege: 'Sol', position: 'space-2', offset: -30 },
                    { name: 'A', solfege: 'La', position: 'line-2', offset: -40 }
                ];

                this.currentSequence = [];
                this.userSequence = [];
                this.score = 0;
                this.level = 1;
                this.streak = 0;

                // Audio context for playing notes
                this.audioContext = null;
                this.initAudio();

                this.initializeElements();
                this.createStaff();
                this.createKeyboard();
                this.attachEventListeners();
                this.updateDisplay();
            }

            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (error) {
                    console.warn('Audio context not available:', error);
                }
            }

            initializeElements() {
                this.scoreElement = document.getElementById('score');
                this.levelElement = document.getElementById('level');
                this.streakElement = document.getElementById('streak');
                this.staffElement = document.getElementById('staff');
                this.userSequenceElement = document.getElementById('userSequence');
                this.keyboardElement = document.getElementById('keyboard');

                this.newSequenceBtn = document.getElementById('newSequenceBtn');
                this.playBtn = document.getElementById('playBtn');
                this.checkBtn = document.getElementById('checkBtn');
                this.clearBtn = document.getElementById('clearBtn');
            }

            createStaff() {
                this.staffElement.innerHTML = '';

                // Create staff lines
                for (let i = 0; i < 5; i++) {
                    const line = document.createElement('div');
                    line.className = 'staff-line';
                    line.style.top = `${40 + i * 30}px`;
                    this.staffElement.appendChild(line);
                }

                // Add treble clef
                const clef = document.createElement('div');
                clef.className = 'clef';
                clef.textContent = 'ùÑû';
                this.staffElement.appendChild(clef);
            }

            createKeyboard() {
                this.keyboardElement.innerHTML = '';

                const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const blackKeys = [
                    { name: 'C#', position: 25 },
                    { name: 'D#', position: 75 },
                    { name: 'F#', position: 175 },
                    { name: 'G#', position: 225 },
                    { name: 'A#', position: 275 }
                ];

                // Create white keys
                whiteKeys.forEach((note, index) => {
                    const key = document.createElement('div');
                    key.className = 'key white-key';
                    key.dataset.note = note;
                    key.textContent = note;
                    key.addEventListener('click', () => this.handleKeyClick(note));
                    this.keyboardElement.appendChild(key);
                });

                // Create black keys
                blackKeys.forEach(({ name, position }) => {
                    const key = document.createElement('div');
                    key.className = 'key black-key';
                    key.dataset.note = name;
                    key.textContent = name;
                    key.style.left = `${position}px`;
                    key.addEventListener('click', () => this.handleKeyClick(name));
                    this.keyboardElement.appendChild(key);
                });
            }

            attachEventListeners() {
                this.newSequenceBtn.addEventListener('click', () => this.generateNewSequence());
                this.playBtn.addEventListener('click', () => this.playSequence());
                this.checkBtn.addEventListener('click', () => this.checkAnswer());
                this.clearBtn.addEventListener('click', () => this.clearUserInput());
            }

            generateNewSequence() {
                // Reset game state
                this.currentSequence = [];
                this.userSequence = [];
                this.clearStaffNotes();
                this.clearUserInput();

                // Generate 6 random notes from the do-la hexachord
                for (let i = 0; i < 6; i++) {
                    const randomNote = this.notes[Math.floor(Math.random() * this.notes.length)];
                    this.currentSequence.push(randomNote);
                }

                this.displayNotesOnStaff();
                this.playBtn.disabled = false;
                this.checkBtn.disabled = false;
            }

            displayNotesOnStaff() {
                this.clearStaffNotes();

                this.currentSequence.forEach((note, index) => {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.textContent = '‚ô©';

                    // Position horizontally
                    noteElement.style.left = `${120 + index * 80}px`;

                    // Position vertically based on note
                    noteElement.style.top = `${70 + note.offset}px`;

                    this.staffElement.appendChild(noteElement);
                });
            }

            clearStaffNotes() {
                const notes = this.staffElement.querySelectorAll('.note');
                notes.forEach(note => note.remove());
            }

            handleKeyClick(noteName) {
                // Only accept notes from the do-la hexachord
                const validNote = this.notes.find(n => n.name === noteName);
                if (!validNote) return;

                this.userSequence.push(validNote);
                this.updateUserSequenceDisplay();

                // Visual feedback
                const key = document.querySelector(`[data-note="${noteName}"]`);
                key.classList.add('active');
                setTimeout(() => key.classList.remove('active'), 200);

                // Play note sound
                this.playNote(validNote);
            }

            updateUserSequenceDisplay() {
                const sequenceText = this.userSequence.map(note =>
                    `${note.name} (${note.solfege})`
                ).join(' ‚Üí ');

                this.userSequenceElement.textContent = sequenceText || 'Your sequence will appear here...';
            }

            clearUserInput() {
                this.userSequence = [];
                this.updateUserSequenceDisplay();

                // Remove all visual feedback from keys
                document.querySelectorAll('.key').forEach(key => {
                    key.classList.remove('correct', 'incorrect', 'active');
                });
            }

            async playSequence() {
                if (!this.audioContext) return;

                for (let i = 0; i < this.currentSequence.length; i++) {
                    this.playNote(this.currentSequence[i]);
                    await this.sleep(600); // Pause between notes
                }
            }

            playNote(note) {
                if (!this.audioContext) return;

                // Calculate frequency (C4 = 261.63 Hz)
                const frequencies = {
                    'C': 261.63,
                    'D': 293.66,
                    'E': 329.63,
                    'F': 349.23,
                    'G': 392.00,
                    'A': 440.00
                };

                const frequency = frequencies[note.name];
                if (!frequency) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.5);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            checkAnswer() {
                if (this.userSequence.length === 0) {
                    this.userSequenceElement.textContent = 'Please play some notes first!';
                    return;
                }

                const isCorrect = this.sequencesMatch();
                this.showResults(isCorrect);

                if (isCorrect) {
                    this.score += 15 + (this.level * 5);
                    this.streak++;

                    if (this.streak % 3 === 0) {
                        this.level++;
                    }
                } else {
                    this.streak = 0;
                }

                this.updateDisplay();

                // Reset for next round
                setTimeout(() => {
                    this.clearUserInput();
                    this.playBtn.disabled = true;
                    this.checkBtn.disabled = true;
                }, 3000);
            }

            sequencesMatch() {
                if (this.userSequence.length !== this.currentSequence.length) {
                    return false;
                }

                for (let i = 0; i < this.currentSequence.length; i++) {
                    if (this.userSequence[i].name !== this.currentSequence[i].name) {
                        return false;
                    }
                }

                return true;
            }

            showResults(isCorrect) {
                // Show correct/incorrect feedback on keys
                this.currentSequence.forEach((note, index) => {
                    const key = document.querySelector(`[data-note="${note.name}"]`);
                    const userNote = this.userSequence[index];

                    if (userNote && userNote.name === note.name) {
                        key.classList.add('correct');
                    } else {
                        key.classList.add('incorrect');
                    }
                });

                if (isCorrect) {
                    this.userSequenceElement.innerHTML = 'üéâ Perfect! You read the notes correctly!';
                } else {
                    const correctSequence = this.currentSequence.map(note =>
                        `${note.name} (${note.solfege})`
                    ).join(' ‚Üí ');
                    this.userSequenceElement.innerHTML = `‚ùå Not quite right.<br>Correct sequence: ${correctSequence}`;
                }
            }

            updateDisplay() {
                this.scoreElement.textContent = this.score;
                this.levelElement.textContent = this.level;
                this.streakElement.textContent = this.streak;
            }
        }

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new NotationGame();
        });
    </script>
</body>
</html>