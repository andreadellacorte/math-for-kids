"use strict";(()=>{var _=window.THREE?window.THREE.OrbitControls:class{},J=window.THREE?window.THREE.RoundedBoxGeometry:class{};(function(){let v=document.getElementById("dice3d"),K=document.getElementById("hud"),l=document.getElementById("rollBtn"),c=document.getElementById("stopBtn"),V=document.getElementById("resetBtn"),k=document.getElementById("statusToast"),z=document.getElementById("amountLabel"),A=document.getElementById("totalLabel"),C=document.getElementById("turnLabel"),q=document.getElementById("playerDot"),I=document.getElementById("prescreen"),D=document.getElementById("onePlayer"),O=document.getElementById("twoPlayers"),w=101,H={pink:"#ffd1dc",blue:"#cce5ff"},n={numPlayers:0,currentPlayerIdx:0,players:[{name:"Player 1",color:H.blue,total:0},{name:"Player 2",color:H.pink,total:0}],rolling:!1,diceEntities:[],world:null,scene:null,camera:null,renderer:null,controls:null,settleTimer:0};function i(o){k.textContent=o}function G(){let o=v.clientWidth,e=v.clientHeight,t=new THREE.WebGLRenderer({antialias:!0,alpha:!0});t.shadowMap.enabled=!0,t.setPixelRatio(Math.min(window.devicePixelRatio||1,2)),t.setSize(o,e),v.appendChild(t.domElement);let r=new THREE.Scene,a=new THREE.PerspectiveCamera(50,o/e,.1,1e3);a.position.set(-10,14,14),a.lookAt(0,0,0);let s=new _(a,t.domElement);s.enablePan=!1,s.enableZoom=!1,s.minPolarAngle=.2,s.maxPolarAngle=Math.PI/2-.1;let u=new THREE.AmbientLight(16777215,.9);r.add(u);let d=new THREE.DirectionalLight(16777215,1.2);d.position.set(-12,18,8),d.castShadow=!0,d.shadow.mapSize.set(1024,1024),r.add(d);let E=new THREE.PlaneGeometry(80,80),y=new THREE.MeshStandardMaterial({color:3114330,metalness:.2,roughness:.8}),f=new THREE.Mesh(E,y);f.rotation.x=-Math.PI/2,f.position.y=-1,f.receiveShadow=!0,r.add(f);let p=new OIMO.World({timestep:1/60,iterations:8,broadphase:2,worldscale:1,random:!0,info:!1,gravity:[0,-9.8*3,0]});p.add({type:"box",size:[160,2,160],pos:[0,-2,0],rot:[0,0,0],move:!1,density:1});let g=20;p.add({type:"box",size:[1,30,160],pos:[-g,15,0],rot:[0,0,0],move:!1,density:1}),p.add({type:"box",size:[1,30,160],pos:[g,15,0],rot:[0,0,0],move:!1,density:1}),n.scene=r,n.camera=a,n.renderer=t,n.controls=s,n.world=p;function h(){requestAnimationFrame(h),n.world&&n.world.step(1/60);for(let m of n.diceEntities){let x=m.body.getPosition(),R=m.body.getQuaternion();m.mesh.position.set(x.x,x.y,x.z),m.mesh.quaternion.set(R.x,R.y,R.z,R.w)}s.update(),t.render(r,a)}requestAnimationFrame(h),window.addEventListener("resize",P);function P(){let m=v.clientWidth,x=v.clientHeight;t.setSize(m,x),a.aspect=m/x||1,a.updateProjectionMatrix()}}function b(o,e=256,t="#ffffff"){let r=document.createElement("canvas");r.width=r.height=e;let a=r.getContext("2d");if(!a)return new THREE.CanvasTexture(r);a.fillStyle=t,a.fillRect(0,0,e,e),a.strokeStyle="#e2e8f0",a.lineWidth=e*.06,a.strokeRect(a.lineWidth/2,a.lineWidth/2,e-a.lineWidth,e-a.lineWidth);let s=e*.08;a.fillStyle="#111827";function u(y,f){let p=[.2,.5,.8][y-1],g=[.2,.5,.8][f-1];a.beginPath(),a.arc(p*e,g*e,s,0,Math.PI*2),a.fill()}let d={1:[[2,2]],2:[[1,1],[3,3]],3:[[1,1],[2,2],[3,3]],4:[[1,1],[3,1],[1,3],[3,3]],5:[[1,1],[3,1],[2,2],[1,3],[3,3]],6:[[1,1],[1,2],[1,3],[3,1],[3,2],[3,3]]};for(let y of d[o]||d[1])u(y[0],y[1]);let E=new THREE.CanvasTexture(r);return E.anisotropy=8,E.needsUpdate=!0,E}function W(o){let e={1:b(1,256,o),2:b(2,256,o),3:b(3,256,o),4:b(4,256,o),5:b(5,256,o),6:b(6,256,o)},t=u=>({map:u,roughness:.45,metalness:.05}),r=[new THREE.MeshStandardMaterial(t(e[3])),new THREE.MeshStandardMaterial(t(e[4])),new THREE.MeshStandardMaterial(t(e[1])),new THREE.MeshStandardMaterial(t(e[6])),new THREE.MeshStandardMaterial(t(e[2])),new THREE.MeshStandardMaterial(t(e[5]))],a=new J(2,2,2,6,.24),s=new THREE.Mesh(a,r);return s.castShadow=!0,s.receiveShadow=!1,s}function F(o){for(let t of n.diceEntities)n.scene.remove(t.mesh);n.diceEntities=[];let e=[{x:-1.4,y:14,z:0},{x:1.4,y:15,z:0}];for(let t=0;t<2;t++){let r=W(o);r.position.set(e[t].x,e[t].y,e[t].z),n.scene.add(r);let a=n.world.add({type:"box",size:[2,2,2],pos:[e[t].x,e[t].y,e[t].z],rot:[Math.random()*360,Math.random()*360,Math.random()*360],move:!0,density:2,friction:.5,restitution:.75});n.diceEntities.push({mesh:r,body:a,color:o})}}function $(o){let e=new THREE.Vector3(0,1,0),t=[{n:new THREE.Vector3(1,0,0),v:3},{n:new THREE.Vector3(-1,0,0),v:4},{n:new THREE.Vector3(0,1,0),v:1},{n:new THREE.Vector3(0,-1,0),v:6},{n:new THREE.Vector3(0,0,1),v:2},{n:new THREE.Vector3(0,0,-1),v:5}],r={dot:-1/0,value:1};for(let a of t){let u=a.n.clone().applyQuaternion(o).dot(e);u>r.dot&&(r={dot:u,value:a.v})}return r.value}function Q(){return n.diceEntities.map(o=>{let e=o.body.getQuaternion(),t=new THREE.Quaternion(e.x,e.y,e.z,e.w);return $(t)})}function T(o){z.textContent=`Amount: ${o||"-"}`;let e=n.players[n.currentPlayerIdx];A.textContent=`Total: ${e.total}`,C.textContent=n.numPlayers===2?n.currentPlayerIdx===0?"Player 1":"Player 2":"Player",q.className="chip-dot "+(n.currentPlayerIdx===0?"blue":"pink")}function N(o){let e=new Map;for(let a of o)e.set(a,(e.get(a)||0)+1);let t=o[0],r=-1;for(let[a,s]of e)s>r&&(t=a,r=s);return t}async function U(o=7,e=50){let t=Array.from({length:n.diceEntities.length},()=>[]);for(let r=0;r<o;r++){let a=Q();for(let s=0;s<a.length;s++)t[s].push(a[s]);await new Promise(s=>setTimeout(s,e))}return t.map(r=>N(r))}function M(o){let e=o&&o.getLinearVelocity?o.getLinearVelocity():{x:0,y:0,z:0},t=o&&o.getAngularVelocity?o.getAngularVelocity():{x:0,y:0,z:0},r=Math.sqrt((e.x||0)*(e.x||0)+(e.y||0)*(e.y||0)+(e.z||0)*(e.z||0)),a=Math.sqrt((t.x||0)*(t.x||0)+(t.y||0)*(t.y||0)+(t.z||0)*(t.z||0));return{lin:r,ang:a}}function j(o=7e3,e=.1,t=.1,r=30,a=900,s=300){return new Promise(u=>{let d=0,E=performance.now();function y(){let f=performance.now(),p=n.diceEntities.length>0&&n.diceEntities.every(h=>{let P=M(h.body);return P.lin<e&&P.ang<t});f-E>=a&&(p?d++:d=0);let g=f-E>o;d>=r||g?setTimeout(()=>{let h=n.diceEntities.length>0&&n.diceEntities.every(P=>{let m=M(P.body);return m.lin<e&&m.ang<t});u(h)},s):requestAnimationFrame(y)}requestAnimationFrame(y)})}function S(){n.numPlayers===2&&(n.currentPlayerIdx=(n.currentPlayerIdx+1)%2,i(`Turn: ${n.currentPlayerIdx===0?"Player 1":"Player 2"}`),T(0))}function B(){let o=n.players[0],e=n.players[1];if(n.numPlayers===1){o.total>w&&i(`Bust! Over by ${o.total-w}.`);return}if(n.currentPlayerIdx===1&&e.total>=0){let t=o.total<=w?o.total:-1/0,r=e.total<=w?e.total:-1/0;t===r?i("Tie!"):t>r?i("Player 1 wins!"):i("Player 2 wins!")}}async function X(){if(n.rolling)return;n.rolling=!0,l.disabled=!0,c.disabled=!0;let o=n.players[n.currentPlayerIdx];i("Rolling..."),F(o.color),await j(7e3,.08,.08,36,1100,350);let e=await U(9,45),t=(e[0]||0)+(e[1]||0);if(o.total+=t,T(t),o.total===w){i("Exact 101! You win!"),n.rolling=!1,l.disabled=!0,c.disabled=!0;return}if(o.total>w){i(`Bust! Over by ${o.total-w}.`),n.rolling=!1,n.numPlayers===2?n.currentPlayerIdx===0?(S(),l.disabled=!1,c.disabled=!1):(B(),l.disabled=!0,c.disabled=!0):(l.disabled=!0,c.disabled=!0);return}i("Choose: Roll again or Stop."),n.rolling=!1,l.disabled=!1,c.disabled=!1}function Y(){n.rolling||(n.numPlayers===2?n.currentPlayerIdx===0?(S(),l.disabled=!1,c.disabled=!1):(B(),l.disabled=!0,c.disabled=!0):(i("Stopped."),l.disabled=!0,c.disabled=!0))}function Z(){for(let o of n.diceEntities)n.scene.remove(o.mesh);n.diceEntities=[],n.players[0].total=0,n.players[1].total=0,n.currentPlayerIdx=0,n.rolling=!1,T(0),i("Press Start"),l.disabled=!1,c.disabled=!1,I.style.display=""}function L(o){n.numPlayers=o,I.style.display="none",i(`Turn: ${o===2?"Player 1":"Player"}`),T(0)}D.addEventListener("click",()=>L(1)),O.addEventListener("click",()=>L(2)),l.addEventListener("click",X),c.addEventListener("click",Y),V.addEventListener("click",Z),G(),T(0)})();})();
